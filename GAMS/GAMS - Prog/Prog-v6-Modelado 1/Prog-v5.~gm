$TITLE Programa-v5

$ONTEXT
Esta es la versión 5 del programa final.
El objetivo será adaptar la versión 4 para hacer cinco simulaciones:
         1.- Sin mejoras
         2.- El coche se va con 18kwh y puede bajar a 0 en algún momento
                 2.1.- El coche se va con la carga con la que llega -> Cambiar en el loop
         3.- Como 2, pero no baja por debajo de su carga inicial
                 3.1.- El coche se va con la carga con la que llega -> Cambiar en el loop
         4.- Como 2, pero se pueden excluir algunos coches COCHEACEPTADO
         5.- Como 3, pero se pueden excluir algunos coches COCHEACEPTADO

También se añadirá un vector COCHEACEPTADO con un 1 en las posiciones de los
coches donde realmente compensa aceptarlo y un 0 cuando se pierde dinero con
ese coche.
También se incluirá un vector FOTOVOLTAICASUPERIOR que controlará los casos de
exceso de producción fotovoltáica.


Utilizaré un vector del precio de la energía por horas:
PRECIOENERGIA = Precio de la energía:
PRECIOENERGIA(i) PRECIOENERGIA / 1
                 2
                 3 ..../

Utilizaré un vector del consumo de la escuela por horas
CONSUMOESCUELA = Consumo de la escuela
CONSUMOESCUELA(i) CESCUELA / 1
                 2
                 3 ..../

Utilizaré un vector de la producción fotovoltáica por horas
PRODUCCIONFOTOVOLTAICA = Producción fotovoltáica de la escuela
PRODUCCIONFOTOVOLTAICA(i) PFOTOVOLTAICA / 1
                      2
                      3 ..../

Utilizaré un vector de 0 y 1 que tendrá un 1 en las posiciones en las que
el coche está en la escuela y un 0 en las que no.
PERIODOESTACIONADO(i) PERIODO DE ESTANCIA  / 1
                      2
                      3 ..../

Utilizaré un vector de los costes por hora (Lo que se gasta por hora en energía)
CONSUMOPORHORA = Coste por hora -> Lo que gasta la escuela
CONSUMOPORHORA(i) CHORA / 1
              2
              3 ..../

FOTOVOLTAICASUPERIOR: Vector de 24 horas que nos indica si en algún momento se
produce más fotovoltáica que el máximo de consumo, caso en el que se "perderá"
ese exceso de producción.

COCHEACEPTADO: un 1 en las posiciones de los coches donde realmente compensa
aceptarlo y un 0 cuando se pierde dinero con ese coche.

La función objetivo a minimizar será:

        Min F(x) = SUM(I,CONSUMOPORHORA(I))) -> Minimizar el sumatorio de los costes/hora

$OFFTEXT



SET
         I HORAS /1*24/
*La hora 1 representa las 0:59, la hora 2 representa las 1:59, ... para CARGA(J,I)
         J COCHES /1*170/;

*Parámetros inventados...Falta sacar los valores reales
PARAMETERS

********************************************************************************************************************************************************************
********************************************************************************************************************************************************************
********************************************************************************************************************************************************************

$ONTEXT
*INVIERNO
  PRECIOENERGIA(I) precio energía  /1        0.14315
2        0.13726
3        0.13355
4        0.13248
5        0.13042
6        0.13326
7        0.13762
8        0.15502
9        0.16342
10        0.15868
11        0.1583
12        0.15595
13        0.15459
14        0.15569
15        0.1531
16        0.15348
17        0.15346
18        0.15686
19        0.16397
20        0.16705
21        0.16928
22        0.1712
23        0.16896
24        0.16353
/

*INVIERNO
  PRODUCCIONFOTOVOLTAICA(I) p. fotovoltaica /1        0
2        0
3        0
4        0
5        0
6        0
7        0
8        0
9        0.031
10        0.926
11        5.199
12        8.181
13        10.129
14        11.208
15        9.998
16        8.1
17        4.232
18        0.185
19        0
20        0
21        0
22        0
23        0
24        0
/

*INVIERNO
  CONSUMOESCUELA(I) consumo escuela /1        16.82254167
2        17.07589167
3        16.80896667
4        16.922075
5        17.335225
6        17.254075
7        18.345375
8        38.20146667
9        61.18709167
10        72.767375
11        78.61703333
12        77.78018333
13        79.43550833
14        74.7873
15        73.60311667
16        74.27143333
17        75.557625
18        77.61494167
19        75.52485833
20        61.31484167
21        28.70408333
22        25.22088333
23        17.48315
24        16.01489167
 /

$OFFTEXT

********************************************************************************************************************************************************************
********************************************************************************************************************************************************************
********************************************************************************************************************************************************************

*$ONTEXT

*PRIMAVERA
  PRECIOENERGIA(I) precio energía  /1        0.10816
2        0.10735
3        0.10422
4        0.10355
5        0.10327
6        0.10324
7        0.10785
8        0.11672
9        0.11528
10        0.11502
11        0.11369
12        0.11213
13        0.11171
14        0.11102
15        0.10973
16        0.10457
17        0.10376
18        0.10346
19        0.1033
20        0.10447
21        0.11124
22        0.1154
23        0.10614
24        0.10381
 /


*PRIMAVERA
  PRODUCCIONFOTOVOLTAICA(I) p. fotovoltaica /1        0
2        0
3        0
4        0
5        0
6        0
7        0
8        0.001
9        0.098
10        1.239
11        4.51
12        6.15
13        8.021
14        10.235
15        10.55
16        9.015
17        6.263
18        2.599
19        0.411
20        0.099
21        0.003
22        0
23        0
24        0
 /


*PRIMAVERA
  CONSUMOESCUELA(I) consumo escuela /1        16.59305833
2        16.53566667
3        16.12069167
4        16.33203333
5        16.21999167
6        16.31400833
7        16.73023333
8        32.99425833
9        54.59871667
10        68.02641667
11        75.00676667
12        76.08936667
13        77.30204167
14        72.61345
15        67.482475
16        62.76636667
17        59.61899167
18        59.96645833
19        54.39643333
20        46.61051667
21        27.03819167
22        25.098225
23        18.88199167
24        17.52773333
/

*$OFFTEXT

********************************************************************************************************************************************************************
********************************************************************************************************************************************************************
********************************************************************************************************************************************************************

$ONTEXT

*VERANO
  PRECIOENERGIA(I) precio energía  /1        0.11069
2        0.10218
3        0.09882
4        0.09676
5        0.095
6        0.09452
7        0.09474
8        0.10171
9        0.10291
10        0.10404
11        0.0999
12        0.10326
13        0.10396
14        0.10536
15        0.10749
16        0.10745
17        0.10654
18        0.10633
19        0.10269
20        0.10257
21        0.10288
22        0.10794
23        0.11157
24        0.11019
/


*VERANO
  PRODUCCIONFOTOVOLTAICA(I) p. fotovoltaica /1        0
2        0
3        0
4        0
5        0
6        0
7        0
8        0
9        0.023
10        0.509
11        2.328
12        6.413
13        8.213
14        9.479
15        10.025
16        7.515
17        2.058
18        1.095
19        0.222
20        0.071
21        0.02
22        0
23        0
24        0
/


*VERANO
  CONSUMOESCUELA(I) consumo escuela /1        15.79004167
2        15.45044167
3        15.74135
4        15.56744167
5        15.770325
6        15.60140833
7        15.73653333
8        22.285925
9        193.0669833
10        192.7126583
11        210.1847083
12        209.2127417
13        221.0418
14        227.11485
15        227.3223083
16        223.0809167
17        229.32465
18        229.8379083
19        221.8427833
20        210.9914083
21        85.29118333
22        21.02435833
23        19.22509167
24        17.026
/

$OFFTEXT


********************************************************************************************************************************************************************
********************************************************************************************************************************************************************
********************************************************************************************************************************************************************

$ONTEXT

*OTOÑO
  PRECIOENERGIA(I) precio energía  /1        0.11755
2        0.11399
3        0.10875
4        0.10754
5        0.10887
6        0.11247
7        0.12376
8        0.12776
9        0.12657
10        0.12526
11        0.12506
12        0.12477
13        0.12525
14        0.12565
15        0.12422
16        0.12139
17        0.12047
18        0.12217
19        0.12332
20        0.12963
21        0.13552
22        0.13099
23        0.11797
24        0.11301
/


*OTOÑO
  PRODUCCIONFOTOVOLTAICA(I) p. fotovoltaica /1        0
2        0
3        0
4        0
5        0
6        0
7        0
8        0
9        0
10        0.07
11        0.267
12        0.524
13        1.271
14        6.042
15        8.195
16        4.285
17        1.621
18        0.496
19        0.103
20        0
21        0
22        0
23        0
24        0
 /

*OTOÑO
  CONSUMOESCUELA(I) consumo escuela /1        16.039925
2        16.15481667
3        16.31661667
4        16.21679167
5        16.27056667
6        16.236575
7        16.92513333
8        21.29335833
9        39.72148333
10        63.06515
11        68.65985833
12        68.76865833
13        67.63531667
14        62.798475
15        58.790275
16        59.39766667
17        61.65389167
18        57.82683333
19        54.876575
20        49.49373333
21        35.350225
22        24.512525
23        18.26321667
24        16.51139167
/


$OFFTEXT


********************************************************************************************************************************************************************
********************************************************************************************************************************************************************
********************************************************************************************************************************************************************


 CARGAINICIAL(J)            Carga inicial en kWh            /
1        21.8225
2        10.6
3        22.325
4        19.8125
5        15.625
6        21.8225
7        22.66
8        19.4775
9        15.625
10        22.1575
11        23.33
12        18.1375
13        21.4875
14        15.625
15        23.464
16        20.315
17        21.8225
18        21.4875
19        23.665
20        22.4925
21        21.4875
22        21.1525
23        19.8125
24        23.41375
25        18.975
26        16.4625
27        23.1625
28        20.315
29        21.4875
30        23.58125
31        21.4875
32        20.65
33        19.8125
34        21.4875
35        21.1525
36        20.315
37        21.99
38        21.4875
39        23.58125
40        20.65
41        19.8125
42        8.925
43        18.975
44        20.83425
45        23.1625
46        23.1625
47        20.65
48        22.325
49        20.985
50        21.4875
51        21.8225
52        22.8275
53        21.8225
54        23.07875
55        19.8125
56        22.325
57        22.325
58        13.615
59        23.4975
60        20.65
61        21.99
62        23.33
63        18.975
64        22.325
65        23.665
66        22.8275
67        23.33
68        18.975
69        23.33
70        17.4675
71        21.655
72        22.325
73        22.325
74        19.8125
75        20.65
76        23.33
77        22.325
78        23.1625
79        21.99
80        23.665
81        22.66
82        13.95
83        20.985
84        19.8125
85        18.975
86        22.19435
87        23.1625
88        20.985
89        20.985
90        19.8125
91        23.665
92        20.65
93        23.33
94        15.625
95        23.33
96        23.33
97        22.8275
98        23.4975
99        13.95
100        15.96
101        17.3
102        21.99
103        14.7875
104        22.66
105        19.4775
106        18.975
107        22.325
108        13.95
109        20.985
110        17.3
111        23.1625
112        21.1525
113        22.8275
114        22.1575
115        22.325
116        22.74375
117        22.74375
118        23.64825
119        21.4875
120        22.325
121        22.995
122        21.8225
123        21.32
124        20.1475
125        23.4975
126        21.99
127        22.66
128        20.65
129        18.1375
130        20.315
131        22.325
132        20.315
133        21.3535
134        22.325
135        22.1575
136        23.4975
137        23.665
138        21.4875
139        23.33
140        23.1625
141        23.665
142        5.575
143        23.4975
144        23.33
145        23.1625
146        21.4875
147        22.8275
148        23.1625
149        22.66
150        22.8275
151        20.315
152        23.129
153        21.32
154        15.625
155        22.995
156        16.4625
157        22.97825
158        22.995
159        20.315
160        23.1625
161        20.65
162        22.995
163        22.57625
164        20.65
165        22.325
166        23.38025
167        21.4875
168        18.975
169        21.1525
170        15.625
/



********************************************************************************************************************************************************************
********************************************************************************************************************************************************************
********************************************************************************************************************************************************************

 HORALLEGADA(J)             Hora de llegada                 /
1        9
2        10
3        10
4        10
5        7
6        16
7        8
8        10
9        9
10        9
11        10
12        10
13        9
14        9
15        10
16        9
17        10
18        11
19        11
20        11
21        11
22        11
23        10
24        10
25        9
26        9
27        10
28        9
29        10
30        9
31        9
32        11
33        15
34        9
35        12
36        9
37        11
38        10
39        9
40        9
41        11
42        10
43        9
44        10
45        10
46        13
47        11
48        11
49        10
50        8
51        9
52        11
53        11
54        10
55        9
56        10
57        10
58        9
59        10
60        9
61        10
62        11
63        10
64        10
65        11
66        10
67        10
68        10
69        10
70        8
71        10
72        10
73        9
74        10
75        8
76        10
77        10
78        10
79        10
80        11
81        10
82        11
83        10
84        11
85        16
86        10
87        10
88        10
89        11
90        9
91        11
92        9
93        8
94        11
95        10
96        14
97        9
98        10
99        8
100        8
101        9
102        8
103        10
104        9
105        13
106        16
107        11
108        10
109        10
110        10
111        10
112        10
113        10
114        10
115        10
116        10
117        12
118        10
119        10
120        11
121        10
122        9
123        10
124        10
125        10
126        13
127        11
128        10
129        10
130        12
131        12
132        19
133        16
134        16
135        9
136        11
137        12
138        10
139        11
140        10
141        9
142        9
143        15
144        18
145        16
146        9
147        10
148        10
149        10
150        13
151        10
152        11
153        12
154        10
155        11
156        18
157        19
158        18
159        9
160        10
161        10
162        10
163        11
164        10
165        10
166        10
167        10
168        10
169        10
170        10

/

********************************************************************************************************************************************************************
********************************************************************************************************************************************************************
********************************************************************************************************************************************************************


 HORASALIDA(J)              Hora de salida                  /
1        19
2        16
3        19
4        17
5        15
6        21
7        20
8        19
9        17
10        18
11        19
12        18
13        18
14        17
15        20
16        15
17        17
18        19
19        20
20        19
21        19
22        20
23        17
24        17
25        17
26        15
27        18
28        16
29        19
30        17
31        17
32        14
33        21
34        16
35        22
36        19
37        18
38        18
39        18
40        15
41        15
42        18
43        18
44        18
45        16
46        20
47        18
48        18
49        18
50        15
51        14
52        12
53        14
54        18
55        19
56        20
57        18
58        19
59        19
60        15
61        18
62        19
63        17
64        16
65        19
66        16
67        19
68        19
69        19
70        18
71        19
72        18
73        17
74        15
75        14
76        19
77        18
78        18
79        18
80        21
81        19
82        17
83        19
84        18
85        21
86        15
87        19
88        19
89        19
90        15
91        22
92        18
93        18
94        18
95        18
96        19
97        17
98        18
99        17
100        14
101        17
102        14
103        16
104        18
105        22
106        21
107        19
108        16
109        13
110        15
111        18
112        18
113        13
114        13
115        21
116        19
117        14
118        13
119        20
120        10
121        14
122        20
123        20
124        14
125        14
126        14
127        20
128        13
129        12
130        14
131        14
132        16
133        18
134        19
135        13
136        13
137        14
138        17
139        16
140        14
141        20
142        14
143        18
144        18
145        18
146        13
147        14
148        14
149        14
150        18
151        17
152        19
153        14
154        14
155        14
156        21
157        21
158        19
159        18
160        12
161        19
162        14
163        21
164        14
165        14
166        12
167        14
168        14
169        20
170        14
/


********************************************************************************************************************************************************************
********************************************************************************************************************************************************************
********************************************************************************************************************************************************************

 FOTOVOLTAICASUPERIOR(I)    Vector con un 1 en las posiciones en las que hay más producción que consumo
 ;
********************************************************************************************************************************************************************
********************************************************************************************************************************************************************
********************************************************************************************************************************************************************


TABLE
*Tabla de 1 y 0 con un 1 en las horas en las que el coche está aparcado.
*Filas -> Coches.
*Columnas -> Horas. La posición 1 corresponde a la carga entre las 0:00 y las 0:59,...
PERIODOESTACIONADO(J, I) PERIODO DE ESTANCIA
         1        2        3        4        5        6        7        8        9        10       11       12       13       14       15       16       17       18       19       20       21       22       23       24
1        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
2        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0
3        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
4        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
5        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0
6        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        0        0        0
7        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        1        1        0        0        0        0
8        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
9        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
10       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
11       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
12       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
13       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
14       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
15       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        0        0        0        0
16       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0
17       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
18       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0
19       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0
20       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0
21       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0
22       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0
23       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
24       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
25       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
26       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0
27       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
28       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0
29       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
30       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
31       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
32       0        0        0        0        0        0        0        0        0        0        1        1        1        1        0        0        0        0        0        0        0        0        0        0
33       0        0        0        0        0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0
34       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0
35       0        0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        0        0
36       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
37       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0
38       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
39       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
40       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0
41       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0
42       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
43       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
44       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
45       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0
46       0        0        0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0
47       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0
48       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0
49       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
50       0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0
51       0        0        0        0        0        0        0        0        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
52       0        0        0        0        0        0        0        0        0        0        1        1        0        0        0        0        0        0        0        0        0        0        0        0
53       0        0        0        0        0        0        0        0        0        0        1        1        1        1        0        0        0        0        0        0        0        0        0        0
54       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
55       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
56       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        0        0        0        0
57       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
58       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
59       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
60       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0
61       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
62       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0
63       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
64       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0
65       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0
66       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0
67       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
68       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
69       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
70       0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
71       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
72       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
73       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
74       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0
75       0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
76       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
77       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
78       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
79       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
80       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        0        0        0
81       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
82       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0
83       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
84       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0
85       0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        0        0        0
86       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0
87       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
88       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
89       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0
90       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0
91       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        1        0        0
92       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
93       0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
94       0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0
95       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
96       0        0        0        0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        0        0        0        0        0
97       0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
98       0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
99       0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
100      0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
101      0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
102      0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
103      0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0
104      0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
105      0        0        0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0
106      0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        0        0        0
107      0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0
108      0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        0        0        0        0        0        0        0        0
109      0        0        0        0        0        0        0        0        0        1        1        1        1        0        0        0        0        0        0        0        0        0        0        0
110      0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0
111      0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
112      0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
113      0        0        0        0        0        0        0        0        0        1        1        1        1        0        0        0        0        0        0        0        0        0        0        0
114      0        0        0        0        0        0        0        0        0        1        1        1        1        0        0        0        0        0        0        0        0        0        0        0
115      0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        1        0        0        0
116      0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
117      0        0        0        0        0        0        0        0        0        0        0        1        1        1        0        0        0        0        0        0        0        0        0        0
118      0        0        0        0        0        0        0        0        0        1        1        1        1        0        0        0        0        0        0        0        0        0        0        0
119      0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        0        0        0        0
120      0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0
121      0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
122      0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        1        0        0        0        0
123      0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        0        0        0        0
124      0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
125      0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
126      0        0        0        0        0        0        0        0        0        0        0        0        1        1        0        0        0        0        0        0        0        0        0        0
127      0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0
128      0        0        0        0        0        0        0        0        0        1        1        1        1        0        0        0        0        0        0        0        0        0        0        0
129      0        0        0        0        0        0        0        0        0        1        1        1        0        0        0        0        0        0        0        0        0        0        0        0
130      0        0        0        0        0        0        0        0        0        0        0        1        1        1        0        0        0        0        0        0        0        0        0        0
131      0        0        0        0        0        0        0        0        0        0        0        1        1        1        0        0        0        0        0        0        0        0        0        0
132      0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0
133      0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        1        1        1        0        0        0        0        0        0
134      0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        1        1        1        1        0        0        0        0        0
135      0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0        0
136      0        0        0        0        0        0        0        0        0        0        1        1        1        0        0        0        0        0        0        0        0        0        0        0
137      0        0        0        0        0        0        0        0        0        0        0        1        1        1        0        0        0        0        0        0        0        0        0        0
138      0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
139      0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        0        0        0        0        0        0        0        0
140      0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
141      0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        1        0        0        0        0
142      0        0        0        0        0        0        0        0        1        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
143      0        0        0        0        0        0        0        0        0        0        0        0        0        0        1        1        1        1        0        0        0        0        0        0
144      0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        1        0        0        0        0        0        0
145      0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        1        1        1        0        0        0        0        0        0
146      0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0        0
147      0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
148      0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
149      0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
150      0        0        0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        0        0        0        0        0        0
151      0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        0        0        0        0        0        0        0
152      0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        0        0        0        0        0
153      0        0        0        0        0        0        0        0        0        0        0        1        1        1        0        0        0        0        0        0        0        0        0        0
154      0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
155      0        0        0        0        0        0        0        0        0        0        1        1        1        1        0        0        0        0        0        0        0        0        0        0
156      0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        1        1        1        1        0        0        0
157      0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        1        1        1        0        0        0
158      0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        0        1        1        0        0        0        0        0
159      0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0        0
160      0        0        0        0        0        0        0        0        0        1        1        1        0        0        0        0        0        0        0        0        0        0        0        0
161      0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        0        0        0        0        0
162      0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
163      0        0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        0        0        0
164      0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
165      0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
166      0        0        0        0        0        0        0        0        0        1        1        1        0        0        0        0        0        0        0        0        0        0        0        0
167      0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
168      0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0
169      0        0        0        0        0        0        0        0        0        1        1        1        1        1        1        1        1        1        1        1        0        0        0        0
170      0        0        0        0        0        0        0        0        0        1        1        1        1        1        0        0        0        0        0        0        0        0        0        0

;


********************************************************************************************************************************************************************
********************************************************************************************************************************************************************
********************************************************************************************************************************************************************

*Para ecuaciones
SCALAR
         CAPACIDAD               Capacidad de la batería en kWh  /24/
         CARGAALASALIDA          Carga minima cuando se va       /0/
         NUMCOCHES               Número de coches                /170/
         RATIOCARGADESCARGA      KWh máximos para (des)carga     /3.68/
         NODESCARGADEBAJODE      No se descarga por debajo de... /4.8/
         MAXPOTENCIA             Máxima potencia contratada      /450/
         MASMENOSESCENARIOSEIS   En el E6 se puede jugar con +-  /4.8/
         RECOMPENSAESEIS         Extra de energía del E6         /0.1/
;

*Para los loop de inicialización
SCALAR
         COUNTERLOOP             Contador para el loop                  /0/
         SUMAAUXESEIS            Auxiliar para E6                       /0/
         CARGAANTERIOR           Carga para el loop cargadesdeprincipio /0/
;

*LOOP para completar el vector FOTOVOLTAICASUPERIOR. Tiene un 1 si la producción
*fotovoltáica en la hora I es menor que el consumo, y un 0 en caso contrario
LOOP(I, if ((CONSUMOESCUELA(I) + (NUMCOCHES*RATIOCARGADESCARGA)) < PRODUCCIONFOTOVOLTAICA(I) , FOTOVOLTAICASUPERIOR(I) = 0;
        else FOTOVOLTAICASUPERIOR(I) = 1;);
    );

*DISPLAY 'FOTOVOLTAICASUPERIOR:', FOTOVOLTAICASUPERIOR;

VARIABLES
F;

PARAMETERS
CARGAINICIALAUXESEIS(J,I);

POSITIVE VARIABLES
CARGA(J,I), CONSUMOPORHORA(I), CARGADESDEPRINCIPIO(J,I);

BINARY VARIABLES
COCHEACEPTADO(J);

*fx para fijar el valor de una variable.
*Este loop inicializa el valor de la carga con CARGAINICIAL.
*Fija ese valor en todas las horas hasta que llega.
LOOP(J, COUNTERLOOP = 0; LOOP(I, COUNTERLOOP = COUNTERLOOP+1;
        if (COUNTERLOOP < HORALLEGADA(J), CARGA.fx(J,I) =  CARGAINICIAL(J););
        if (COUNTERLOOP = 24, COUNTERLOOP = 0;);
    ););


*lo para poner el límite inferior de una variable.
*Este loop pone un límite inferior a la carga de salida. Aseguramos que el
*coche se va con una carga mínima.
*PARA SIMULACIONES 2.1 Y 3.1 CAMBIAR CARGAALASALIDA POR CARGAINICIAL(J).
LOOP(J, COUNTERLOOP = 0;
LOOP(I, COUNTERLOOP = COUNTERLOOP+1;
        if (COUNTERLOOP >= HORASALIDA(J), if(CARGAINICIAL(J) > CARGAALASALIDA, CARGA.lo(J,I) = CARGAINICIAL(J); else CARGA.lo(J,I) =  CARGAALASALIDA;); ;);
        if (COUNTERLOOP = 24, COUNTERLOOP = 0;);
    ););



*Comentar para escenario 6
*$ONTEXT

LOOP(J,
LOOP(I, CARGAINICIALAUXESEIS(J,I)  =  CARGAINICIAL(J);););

LOOP(J, COUNTERLOOP = 0; SUMAAUXESEIS = CARGAINICIAL(J)+RECOMPENSAESEIS;
LOOP(I, COUNTERLOOP = COUNTERLOOP+1;
        if (COUNTERLOOP >= HORASALIDA(J), CARGA.fx(J,I) = SUMAAUXESEIS;);
        if (COUNTERLOOP = 24, COUNTERLOOP = 0;);
    ););

*$OFFTEXT


*Los siguientes 2 loop (2 loop dobles) son para iniciar CARGADESDEPRINCIPIO para la primera iteración.
*El primero fija la carga inicial hasta que llega a la universidad.
LOOP(J , COUNTERLOOP = 0; LOOP(I, COUNTERLOOP = COUNTERLOOP+1;
        if (COUNTERLOOP < HORALLEGADA(J), CARGADESDEPRINCIPIO.fx(J,I) =  CARGAINICIAL(J););
        if (COUNTERLOOP = 24, COUNTERLOOP = 0;);
    ););

*El loop (el segundo de CARGADESDEPRINCIPIO) fija en cada hora la carga si se cargase desde el princiio.
*Fijará Carga(i-1)+RATIODEDESCARGA hasta llegar a la CARGAALASALIDA. Después fijará CARGAALASALIDA.
LOOP(J,  CARGAANTERIOR = CARGAINICIAL(J); COUNTERLOOP = 0;
LOOP(I, COUNTERLOOP = COUNTERLOOP+1;
        if (CARGAINICIAL(J) < CARGAALASALIDA,
        if (COUNTERLOOP >= HORALLEGADA(J) AND COUNTERLOOP <= (HORALLEGADA(J) + ((CARGAALASALIDA-CARGAINICIAL(J))/RATIOCARGADESCARGA)-1) AND (CARGAANTERIOR < CARGAALASALIDA - RATIOCARGADESCARGA), CARGADESDEPRINCIPIO.fx(J,I) = CARGAANTERIOR + RATIOCARGADESCARGA; CARGAANTERIOR = CARGAANTERIOR + RATIOCARGADESCARGA;);
        if (COUNTERLOOP > (HORALLEGADA(J) + ((CARGAALASALIDA-CARGAINICIAL(J))/RATIOCARGADESCARGA)-1), CARGADESDEPRINCIPIO.fx(J,I) =  CARGAALASALIDA;);
        ;
        else CARGADESDEPRINCIPIO.fx(J,I) =  CARGAINICIAL(J););
        if (COUNTERLOOP = 24, COUNTERLOOP = 0;);
    ););



EQUATIONS
     OBJ                         La función objetivo
     COSTESINCOCHES(I)           Función para comparar el coste si no se usase este algoritmo
     ITERACION(I)                Función de las horas 1 a la 24
     ITERACIONCOCHEACEPTADO(I)   Función de las horas 1 a la 24 que incluye la variable binaria COCHEACEPTADO(I)
     ITERACIONCARGAPRINCIPIO(I)  Función que sirve para cargar al máximo en el momento en que llega
     CAPACIDADMAX(J,I)           Función que condiciona la carga de la batería a la capacidad
     CARGAMAX(J,I)               Función que condiciona la carga  por hora máxima a 3.68 kWh
     DESCARGAMAX(J,I)            Función que condiciona la descarga  por hora máxima a 3.68 kWh
     NODESCARGADEBAJO(J,I)       Función que no permite descarga por debajo de la carga con la que llega el coche
     CARGALIMITADA(J,I)          Función que limita la descarga máxima de la batería a 4.8 kWh
     DINEROPOSITIVO(I)           Nunca se puede ganar dinero vendiendo energía
     MAXGASTO(I)                 No superar los 450 kW
     ESEISMAX(J,I)               Máximo valor del escenario 6
     ESEISMIN(J,I)               Mínimo valor del escenario 6
;

OBJ ..                           F  =E=  sum(I, CONSUMOPORHORA(I));

COSTESINCOCHES(I) ..             FOTOVOLTAICASUPERIOR(I)*(PRECIOENERGIA(I)*[CONSUMOESCUELA(I) - PRODUCCIONFOTOVOLTAICA(I)]) =E= CONSUMOPORHORA(I);

ITERACION(I) ..                  FOTOVOLTAICASUPERIOR(I)*(PRECIOENERGIA(I)*[CONSUMOESCUELA(I) - PRODUCCIONFOTOVOLTAICA(I) + sum(J,[[CARGA(J,I) - CARGA(J,I-1)]*PERIODOESTACIONADO(J,I)])]) =E=  CONSUMOPORHORA(I) ;

ITERACIONCARGAPRINCIPIO(I) ..    FOTOVOLTAICASUPERIOR(I)*(PRECIOENERGIA(I)*[CONSUMOESCUELA(I) - PRODUCCIONFOTOVOLTAICA(I) + sum(J,[[CARGADESDEPRINCIPIO(J,I) - CARGADESDEPRINCIPIO(J,I-1)]*PERIODOESTACIONADO(J,I)])]) =E=  CONSUMOPORHORA(I) ;

ITERACIONCOCHEACEPTADO(I) ..     FOTOVOLTAICASUPERIOR(I)*(PRECIOENERGIA(I)*[CONSUMOESCUELA(I) - PRODUCCIONFOTOVOLTAICA(I) + sum(J,COCHEACEPTADO(J)*[[CARGA(J,I) - CARGA(J,I-1)]*PERIODOESTACIONADO(J,I)])]) =E=  CONSUMOPORHORA(I) ;

CAPACIDADMAX(J,I) ..             CARGA(J,I) =L= CAPACIDAD;

CARGAMAX(J,I) ..                 CARGA(J,I+1) - CARGA(J,I) =L= RATIOCARGADESCARGA;

DESCARGAMAX(J,I) ..              CARGA(J,I) - CARGA(J,I-1) =G= -RATIOCARGADESCARGA;

NODESCARGADEBAJO(J,I) ..         CARGA(J,I) =G= CARGAINICIAL(J);

*
CARGALIMITADA(J,I) ..            CARGA(J,I) =G= NODESCARGADEBAJODE;

DINEROPOSITIVO(I) ..             CONSUMOPORHORA(I) =G= 0.000001;

MAXGASTO(I) ..                   CONSUMOPORHORA(I) =L= PRECIOENERGIA(I)*450;

ESEISMAX(J,I) ..                 CARGA(J,I) =L=  CARGAINICIALAUXESEIS(J,I) + MASMENOSESCENARIOSEIS;

ESEISMIN(J,I) ..                 CARGA(J,I) =G=  CARGAINICIALAUXESEIS(J,I) - MASMENOSESCENARIOSEIS;

$ONTEXT
Cinco simulaciones:
         1.- Sin mejoras
         2.- El coche se va con 18kwh y puede bajar a 0 en algún momento
                 2.1.- El coche se va con la carga con la que llega -> Cambiar en el loop
         3.- Como 2, pero no baja por debajo de su carga inicial
                 3.1.- El coche se va con la carga con la que llega -> Cambiar en el loop
         4.- Como 2, pero se pueden excluir algunos coches COCHEACEPTADO
         5.- Como 3, pero se pueden excluir algunos coches COCHEACEPTADO
$OFFTEXT

MODEL progSinCoches /OBJ,COSTESINCOCHES/ ;
MODEL progConCoches1 /OBJ, ITERACIONCARGAPRINCIPIO/;
MODEL progConCoches2 /OBJ,ITERACION, CAPACIDADMAX, CARGAMAX, DESCARGAMAX, CARGALIMITADA, DINEROPOSITIVO, MAXGASTO/ ;
MODEL progConCoches3 /OBJ,ITERACION, CAPACIDADMAX, CARGAMAX, DESCARGAMAX, NODESCARGADEBAJO, CARGALIMITADA, DINEROPOSITIVO, MAXGASTO/ ;
MODEL progConCoches6 /OBJ,ITERACION, CAPACIDADMAX, CARGAMAX, DESCARGAMAX, CARGALIMITADA, DINEROPOSITIVO, MAXGASTO, ESEISMAX, ESEISMIN/ ;
*MODEL progConCoches4 /OBJ, ITERACIONCOCHEACEPTADO, CAPACIDADMAX, CARGAMAX, DESCARGAMAX, CARGALIMITADA, DINEROPOSITIVO/ ;
*MODEL progConCoches5 /OBJ, ITERACIONCOCHEACEPTADO, CAPACIDADMAX, CARGAMAX, DESCARGAMAX, NODESCARGADEBAJO, CARGALIMITADA, DINEROPOSITIVO/ ;

*SOLVE progSinCoches using lp minimizing F;
*SOLVE progConCoches1 using lp minimizing F;
*SOLVE progConCoches2 using lp minimizing F;
*SOLVE progConCoches3 using lp minimizing F;
SOLVE progConCoches6 using lp minimizing F;

*MINLP -> Mixed integer non linear programing
*SOLVE progConCoches4 using MINLP minimizing F;
*SOLVE progConCoches5 using MIP minimizing F;
